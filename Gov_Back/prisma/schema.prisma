generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =========================
// ENUMS
// =========================

enum VoiceSessionStatus {
  ACTIVE
  COMPLETED
  DROPPED
}

enum NotificationType {
  SMS
  EMAIL
}
enum ReminderJobStatus {
  PENDING
  SENT
  FAILED
  CANCELLED
}

// =========================
// USERS
// =========================
model User {
  id                String   @id
  nationalId        String?  @unique @map("national_id")
  phoneNumber       String?  @unique @map("phone_number")
  email             String?  @unique @map("email") // ✅ جديد

firstName  String @map("first_name")
secondName String @map("second_name")
thirdName  String @map("third_name")
familyName String @map("family_name")

  // ✅ Reminder settings (أبسط حل)
  reminderEnabled   Boolean  @default(false) @map("reminder_enabled")
  reminderOffsetMin Int?     @map("reminder_offset_min") // مثال: 1440 يوم
  reminderViaSms    Boolean  @default(false) @map("reminder_via_sms")
  reminderViaEmail  Boolean  @default(false) @map("reminder_via_email")

  preferredLanguage String   @default("ar") @map("preferred_language")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @default(now()) @map("updated_at")

  appointments  Appointment[]
  otpRequests   OtpRequest[]
  notifications Notification[]

  reminderJobs ReminderJob[]

  @@map("users")
}

// =========================
// ADMIN USERS
// =========================
model AdminUser {
  id           String   @id
  username     String   @unique
  passwordHash String   @map("password_hash")
  role         String   @default("admin")
  createdAt    DateTime @default(now()) @map("created_at")

  auditLogs AuditLog[]

  @@map("admin_users")
}

// =========================
// SERVICES
// =========================
model Service {
  id            String   @id
  canonicalName String   @unique @map("canonical_name")
  description   String?
  searchText    String   @map("search_text")
  embedding     Float[]
  voiceText     String   @map("voice_text")
  price         Decimal?
  currency      String   @default("JOD")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @default(now()) @map("updated_at")

  documents     ServiceDocument[]
  appointments  Appointment[]

  @@map("services")
}

// =========================
// SERVICE DOCUMENTS
// =========================
model ServiceDocument {
  id           String   @id
  serviceId    String   @map("service_id")
  documentName String   @map("document_name")
  documentType String?  @map("document_type")
  description  String?
  voiceText    String   @map("voice_text")
  isRequired   Boolean  @default(true) @map("is_required")
  sortOrder    Int?     @map("sort_order")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @default(now()) @map("updated_at")

  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@map("service_documents")
}

// =========================
// APPOINTMENTS
// =========================
model Appointment {
  id              String   @id
  userId          String   @map("user_id")
  serviceId       String   @map("service_id")

  // ✅ لازم تكون Timestamptz
  appointmentDate DateTime @db.Timestamptz(3) @map("appointment_date")
  appointmentTime DateTime @db.Timestamptz(3) @map("appointment_time")

  status          String   @default("UPCOMING") @map("status")

  createdAt       DateTime @default(now()) @db.Timestamptz(3) @map("created_at")
  updatedAt       DateTime @updatedAt      @db.Timestamptz(3) @map("updated_at")

  user    User    @relation(fields: [userId], references: [id])
  service Service @relation(fields: [serviceId], references: [id])

  reminderJob ReminderJob?

  @@index([userId, appointmentDate])
  @@index([userId, serviceId, status])
  @@map("appointments")
}

// =========================
// OTP REQUESTS
// =========================
model OtpRequest {
  id         String   @id
  userId     String   @map("user_id")
  otpCode    String   @map("otp_code")
  expiresAt  DateTime @map("expires_at")
  isVerified Boolean  @default(false) @map("is_verified")
  createdAt  DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@map("otp_requests")
}

// =========================
// VOICE SESSIONS
// =========================
model VoiceSession {
  id            String   @id @default(uuid())
  userId        String?  @map("user_id")
  sessionStatus String   @default("ACTIVE") @map("session_status")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("voice_sessions")
}

// =========================
// NOTIFICATIONS
// =========================
model Notification {
  id        String           @id
  userId    String           @map("user_id")
  type      NotificationType
  content   String
  sentAt    DateTime? @db.Timestamptz(3) @map("sent_at")
createdAt DateTime @default(now()) @db.Timestamptz(3) @map("created_at")
updatedAt DateTime @updatedAt      @db.Timestamptz(3) @map("updated_at")

  user User @relation(fields: [userId], references: [id])

  @@map("notifications")
}
model ReminderJob {
  id            String           @id
  userId        String           @map("user_id")
  appointmentId String           @unique @map("appointment_id") // job واحد لكل موعد (بدنا أبسط نسخة)
  scheduledAt   DateTime @db.Timestamptz(3) @map("scheduled_at")
  viaSms        Boolean          @default(false) @map("via_sms")
  viaEmail      Boolean          @default(false) @map("via_email")
  status        ReminderJobStatus @default(PENDING)
  attempts      Int              @default(0)
  lastError     String?          @map("last_error")
createdAt DateTime @default(now()) @db.Timestamptz(3) @map("created_at")
updatedAt DateTime @updatedAt      @db.Timestamptz(3) @map("updated_at")


  user        User        @relation(fields: [userId], references: [id])
  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@index([status, scheduledAt])
  @@map("reminder_jobs")
}

// =========================
// SERVICE SUGGESTIONS
// =========================
model ServiceSuggestion {
  id                String   @id
  userQuery         String   @map("user_query")
  suggestedServices Json
  createdAt         DateTime @default(now()) @map("created_at")

  @@map("service_suggestions")
}

// =========================
// AUDIT LOGS
// =========================
model AuditLog {
  id        String   @id
  adminId   String   @map("admin_id")
  action    String
  entity    String
  entityId  String?  @map("entity_id")
  timestamp DateTime @default(now())

  admin AdminUser @relation(fields: [adminId], references: [id])

  @@map("audit_logs")
}
